name: CI

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure required files exist
        run: |
          set -euo pipefail
          for f in \
            index.html research.html repositories.html notes.html blog.html contact.html tools.html \
            assets/css/styles.css assets/js/nav.js \
          ; do
            if [ ! -f "$f" ]; then
              echo "Missing required file: $f" >&2
              exit 1
            fi
          done

      - name: Verify HTML files are non-empty
        run: |
          set -euo pipefail
          for f in index.html research.html repositories.html notes.html blog.html contact.html tools.html; do
            if [ ! -s "$f" ]; then
              echo "File is empty: $f" >&2
              exit 1
            fi
          done

      - name: Check local asset references
        run: |
          set -euo pipefail
          python - <<'PY'
          import pathlib, re, sys
          from urllib.parse import unquote

          pages = [
              "index.html",
              "research.html",
              "repositories.html",
              "notes.html",
              "blog.html",
              "contact.html",
              "tools.html",
          ]

          missing = []

          for page in pages:
              html = pathlib.Path(page).read_text(encoding="utf-8")
              for attr in ("href", "src"):
                  for m in re.finditer(attr + r'="([^"]+)"', html):
                      target = m.group(1)
                      if target.startswith(("http://", "https://", "mailto:", "tel:", "#")):
                          continue
                      # drop fragment/query and decode %20, etc.
                      target = target.split("#", 1)[0].split("?", 1)[0]
                      target = unquote(target)
                      # skip absolute-root or protocol-relative refs
                      if target.startswith(("/", "//")) or not target:
                          continue
                      if not pathlib.Path(target).exists():
                          missing.append((page, target))

          if missing:
              for page, target in missing:
                  print(f"{page} references missing {target}")
              sys.exit(1)
          PY